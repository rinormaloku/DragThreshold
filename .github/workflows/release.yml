name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize and update submodules
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive --force

    - name: Verify submodule
      run: |
        echo "Checking submodule directory..."
        ls -la .modules/
        ls -la .modules/OpenTabletDriver/ || echo "OpenTabletDriver directory not found"
        test -f .modules/OpenTabletDriver/OpenTabletDriver.Plugin/OpenTabletDriver.Plugin.csproj && echo "Project file found!" || echo "Project file NOT found!"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build plugin
      run: dotnet build -c Release

    - name: Create release package
      run: ./scripts/create-release.sh

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: DragThreshold.zip
        body: |
          ## Installation

          1. Download `DragThreshold.zip`
          2. Extract to your OpenTabletDriver plugins directory:
             - Linux: `~/.config/OpenTabletDriver/Plugins/DragThreshold/`
             - Windows: `%localappdata%\OpenTabletDriver\Plugins\DragThreshold\`
          3. Restart OpenTabletDriver
          4. Enable the filter in the Filters tab

          ## Changes
          See commit history for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
