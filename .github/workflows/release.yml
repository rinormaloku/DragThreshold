name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Initialize submodules
      run: |
        git submodule init
        git submodule update --recursive

    - name: Verify submodule
      run: |
        echo "Checking submodule directory..."
        ls -la .modules/
        ls -la .modules/OpenTabletDriver/ || echo "OpenTabletDriver directory not found"
        test -f .modules/OpenTabletDriver/OpenTabletDriver.Plugin/OpenTabletDriver.Plugin.csproj && echo "Project file found!" || echo "Project file NOT found!"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build plugin
      run: dotnet build -c Release

    - name: Create release package
      run: |
        mkdir -p release/DragThreshold
        cp DragThreshold/bin/Release/net10.0/DragThreshold.dll release/DragThreshold/
        cp DragThreshold/bin/Release/net10.0/DragThreshold.deps.json release/DragThreshold/
        cd release
        zip -r DragThreshold.zip DragThreshold/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/DragThreshold.zip
        body: |
          ## Installation

          1. Download `DragThreshold.zip`
          2. Extract the `DragThreshold` folder
          3. Copy the folder to your OpenTabletDriver plugins directory:
             - Linux: `~/.config/OpenTabletDriver/Plugins/`
             - Windows: `%localappdata%\OpenTabletDriver\Plugins\`
          4. Restart OpenTabletDriver
          5. Enable the filter in the Filters tab

          ## Changes
          See commit history for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
